## 智能编程模型

### 异构编程模型 

系统组成
+ **通用处理器**：控制设备，负责**控制和调度**
+ **领域处理器**：从设备，负责**大规模并行或领域专用计算**任务
+ 二者协同完成计算任务
![](../../08-Assets/Pasted%20image%2020220822203731.png)

典型的异构计算系统
1. GPU 为核心
2. FPGA 为核心
3. TPU 为核心
4. DLP 为何心

### 异构编程模型：分类

用户接口角度大概分为两类
+ 构建全新异构并行编程
+ 对现有编程语言进行异构并行扩展

![](../../08-Assets/Pasted%20image%2020220822204747.png#center|典型异构并行编程模型对比)
### 异构编程模型：流程

异构编程模型的变异和链接流程，整体采用分离式编程方式：主机端代码和设备端代码

![](../../08-Assets/Pasted%20image%2020220822204839.png)

 ### 编译器支持

![](../../08-Assets/Pasted%20image%2020220822205101.png)

+ 任务划分：**定义和划分任务**，用户可以在程序中根据任务id指定任务在几个核
+ 数据分布：智能计算设备对数据布局的影响，
+ 数据通信：主机和设备端或设备之间的通信
+ 并行同步：同步机制的支持

> 应当方便程序猿注重业务逻辑。

### 运行时支持 

+ **任务映射及调度**，指定任务具体在**哪个设备或计算单元**上以**何种顺序**执行
+ 分为主机端和设备端
	+ 主机端：串行任务 (控制)
	+ 设备端：并行任务（计算）

## 通用智能编程模型

+  以异构编程模型为基础
	+ Kernel 函数定义：定义设备端 DLP 上的核心计算任务
	+ 编译器支持：指定 DLP 的核心人物如何高效地翻译成目标代码 
	+ 运行时支持：指定任务和计算单元的映射

> DLP = Data Level Parallelism 即数据集并行 

### Kernel 定义

![](../../08-Assets/Pasted%20image%2020220822210711.png)

DLP 上执行的任务叫 Kernel，可以同时执行多个 Kernel 
+ 每个Kernel 有一个**入口函数**
+ Kernel 的启动需要调用运行时 API (主机端调用)


### 编译器支持

![](../../08-Assets/Pasted%20image%2020220822211328.png)
![](../../08-Assets/Pasted%20image%2020220822211656.png)![](../../08-Assets/Pasted%20image%2020220822211824.png)
**一个 chip 里面多个 cluster, 一个 cluster 里多个 core。**

+ 任务调度
	+ 表示Kernel运行调度时需要的硬件核 
	+ BLOCK，核调度
	+ UNIONx，cluster 调度，需要x个cluster

+ 数据通信
	+ 隐式数据管理：编译器隐式插入
	+ 显式：
		+ DRAM/NRAM/WRAM/SRAM间向量及张量
		+ 主机-DLP 之间
+ 同步支持
	+ \_\_sync_all
	+ \_\_sync_cluster 
+ 内建运算：为用户变成提供支持
![](../../08-Assets/Pasted%20image%2020220822211922.png)

### 运行时支持

调度和映射
![](../../08-Assets/Pasted%20image%2020220822212009.png) 
+ 任务调度单位（BLOCK/UNIOMx）
+ 队列 

#### 例子 

![](../../08-Assets/Pasted%20image%2020220822212106.png)

![](../../08-Assets/Pasted%20image%2020220822213836.png)![](../../08-Assets/Pasted%20image%2020220822213908.png)
## BANG 异构编程 

BANG 语言是针对 MLU 硬件提出的编程语言，兼顾云边端...

![](../../08-Assets/Pasted%20image%2020220822214014.png)

> 是寒武纪开发的

### BANG异构编程流程

![](../../08-Assets/Pasted%20image%2020220822214308.png)


### 编程示例：主机端

![](../../08-Assets/Pasted%20image%2020220822214903.png)

### 编程实例：设备端（BANG 语言）

![](../../08-Assets/Pasted%20image%2020220822215040.png)

### 编译和链接

![](../../08-Assets/Pasted%20image%2020220822215501.png)

## 智能编程语言基础 

### 语法概述

基于过程式语言。
+ 减少用户学习成本
+ 可以描述为明确的过程，适合采用过程式语言描述

具有数据和函数两个基本要素，函数体和 C 语言基本一致。

### 基本数据类型

### 宏、常量、内置变量

内置变量是语言既有的，宏/常量由用户定义

+ 宏和常量，
### I/O操作语句

![](../../08-Assets/Pasted%20image%2020220822233834.png)
![](../../08-Assets/Pasted%20image%2020220822233935.png)

### 标量计算语句 
+ 运算符号 + - `*` /
+ 内建函数，`abs max min`

### 张量计算语句 

+ 张量计算语句是智能编程语言的主要特点，可以通过**内建函数直接映射到张量计算单元**
+ 张量计算直接对精度类型和语义类型等数据直接进行操作
![](../../08-Assets/Pasted%20image%2020220822234402.png)

### 控制流语句

+ 分支语句
+ 循环语句
+ 同步语句

![](../../08-Assets/Pasted%20image%2020220822234514.png)


### 串行程序示例 
![](../../08-Assets/Pasted%20image%2020220822235055.png)

### 并行程序示例 

![](../../08-Assets/Pasted%20image%2020220822235944.png)

### 张量计算语句实例：BANG数学库

![](../../08-Assets/Pasted%20image%2020220823000730.png)

![](../../08-Assets/Pasted%20image%2020220823000821.png)

![](../../08-Assets/Pasted%20image%2020220823000834.png)
![](../../08-Assets/Pasted%20image%2020220823000847.png)![](../../08-Assets/Pasted%20image%2020220823000853.png)
![](../../08-Assets/Pasted%20image%2020220823000900.png)
